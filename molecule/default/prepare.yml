---
- name: Set up container to behave like a Docker host
  hosts: all
  become: true
  tasks:
    - name: Update apt cache (Ubuntu)
      ansible.builtin.apt:
        update_cache: true
      when: ansible_distribution == "Ubuntu"
    # Apply the Docker socket workaround in https://github.com/ansible-community/molecule/issues/1568
    - name: Link the docker socket
      ansible.builtin.file:
        src: /tmp/docker.sock
        dest: /var/run/docker.sock
        state: link
      changed_when: false
    - name: Install the docker module
      ansible.builtin.pip:
        name:
          - docker
          - docker-compose
        state: present

# Preparation steps required for DNS setup - shared with docker-only variant
- name: Set up DNS environment
  hosts: all
  become: true
  tags:
    - prepare
  vars:
    run_type: "{{ lookup('ansible.builtin.env', 'RUN_TYPE') }}"
    base_domain: "{{ lookup('ansible.builtin.env', 'BASE_DOMAIN') }}"
    temp_work_dir: "{{ lookup('ansible.builtin.env', 'TEMP_WORK_DIR') }}"
    desec_script: "desec.py"
  tasks:
    - name: Include DNS setup tasks
      ansible.builtin.import_tasks: tasks/prepare-dns.yml
